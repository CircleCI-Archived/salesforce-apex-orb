description: >
  An opinionated automation job for deploying your salesforce application to a scratch organization,
  executing apex unit testing, and finally removing the scratch org. Check this job's source for the
  full list of commands ran.
executor:
  name: sfdx/default
  tag: << parameters.tag >>
parameters:
  tag:
    description: Version tag for the SFDX executor.
    type: string
    default: "12.6"
  cli-version:
    description: By default, the latest version of the standalone CLI will be installed. To install via npm, supply a version tag such as "latest" or "6".
    default: ""
    type: string
  organization-alias:
    description: Sets an alias for the scratch org to ensure commands are run against the correct org.
    type: string
  scratch-def:
    description: Full path to scratch org definition json file. Example:"./config/project-scratch-def.json"
    type: string
  permset:
    description: "Assign a pre-defined permission set to the default user. Learn more: https://help.salesforce.com/articleView?id=perm_sets_create.htm&type=5"
    type: string
  sampledata-path:
    description: "Path location to sample data json file. Example: ./data/sample-data-plan.json"
    type: string
  manifest:
    description: "File path for manifest file (package.xml) of components to deploy."
    type: string
    default: ""
  sourcepath:
    description: "Directory to deploy."
    type: string
    default: ""
  deploy-dir:
    description: "Directory to deploy."
    type: string
    default: ""
  defaultusername:
    description: The username for an org that all commands run against by default.
    type: string
  source-deploy-wait-time:
    description: "Maximum amount of time to complete source deployment."
    type: integer
    default: 5
  test-wait-time:
    description: "Maximum amount of time to complete tests."
    type: integer
    default: 10

steps:
  - checkout
  - setup:
      version: <<parameters.cli-version>>
      defaultusername: <<parameters.defaultusername>>
  - scratch-up:
      scratch-config: <<parameters.scratch-def>>
      scratch-alias: <<parameters.organization-alias>>
  - source-push:
      organization-alias: <<parameters.organization-alias>>
  - run:
      name: Assign Permissions
      command: sfdx force:user:permset:assign -n <<parameters.permset>>
  - run:
      name: Load Sample Data
      command: sfdx force:data:tree:import --plan <<parameters.sampledata-path>>
  - when:
      condition: << parameters.deploy-dir >>
      steps:
        - mdapi-deploy:
            organization-alias: <<parameters.organization-alias>>
            deploy-dir: <<parameters.deploy-dir>>
            wait-time: <<parameters.source-deploy-wait-time>>
  - when:
      condition:
        or: [<< parameters.sourcepath >>, << parameters.manifest >>]
      steps:
        - source-deploy:
            organization-alias: <<parameters.organization-alias>>
            sourcepath: <<parameters.sourcepath>>
            manifest: <<parameters.manifest>>
            wait-time: <<parameters.source-deploy-wait-time>>
  - test:
      organization-alias: <<parameters.organization-alias>>
      wait-time: <<parameters.test-wait-time>>
  - scratch-down:
      scratch-alias: <<parameters.organization-alias>>
